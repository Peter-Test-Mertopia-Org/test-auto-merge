name: Auto Merge Release Branch

on:
  push:
    branches:
      - "release/v*"

# è¨­å®š GITHUB_TOKEN æ¬Šé™
permissions:
  contents: write
  pull-requests: write

jobs:
  # ç¬¬ä¸€å€‹ jobï¼šè¨ˆç®—éœ€è¦åˆä½µçš„ç›®æ¨™åˆ†æ”¯
  calculate-targets:
    runs-on: ubuntu-latest
    # è·³éç”± GitHub Actions bot è§¸ç™¼çš„ pushï¼Œé¿å…å·¢ç‹€è§¸ç™¼
    if: github.actor != 'github-actions[bot]'
    outputs:
      target-branches: ${{ steps.get-targets.outputs.branches }}
      source-branch: ${{ steps.get-targets.outputs.source }}
      has-targets: ${{ steps.get-targets.outputs.has_targets }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Calculate target branches
        id: get-targets
        run: |
          # å–å¾—è§¸ç™¼çš„åˆ†æ”¯åç¨± (ä¾‹å¦‚: release/v0.146)
          SOURCE_BRANCH="${GITHUB_REF#refs/heads/}"
          echo "source=$SOURCE_BRANCH" >> $GITHUB_OUTPUT
          echo "Source branch: $SOURCE_BRANCH"

          # è§£æç‰ˆæœ¬è™Ÿ (ä¾‹å¦‚: 0.146 -> major=0, minor=146)
          VERSION=$(echo "$SOURCE_BRANCH" | sed 's/release\/v//')
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          MINOR=$(echo "$VERSION" | cut -d. -f2)
          echo "Current version: $MAJOR.$MINOR"

          # å–å¾—æ‰€æœ‰ remote release åˆ†æ”¯
          git fetch origin
          ALL_RELEASES=$(git branch -r | grep 'origin/release/v' | sed 's/origin\///' | tr -d ' ')

          # æ‰¾å‡ºç‰ˆæœ¬è™Ÿæ¯”ç•¶å‰åˆ†æ”¯æ›´é«˜çš„ release åˆ†æ”¯
          HIGHER_RELEASES=""
          for BRANCH in $ALL_RELEASES; do
            BRANCH_VERSION=$(echo "$BRANCH" | sed 's/release\/v//')
            BRANCH_MAJOR=$(echo "$BRANCH_VERSION" | cut -d. -f1)
            BRANCH_MINOR=$(echo "$BRANCH_VERSION" | cut -d. -f2)

            # æ¯”è¼ƒç‰ˆæœ¬è™Ÿ
            if [ "$BRANCH_MAJOR" -gt "$MAJOR" ] 2>/dev/null || \
               ([ "$BRANCH_MAJOR" -eq "$MAJOR" ] && [ "$BRANCH_MINOR" -gt "$MINOR" ] 2>/dev/null); then
              HIGHER_RELEASES="$HIGHER_RELEASES $BRANCH"
              echo "Found higher version: $BRANCH"
            fi
          done

          # çµ„åˆç›®æ¨™åˆ†æ”¯åˆ—è¡¨ (develop + æ›´é«˜ç‰ˆæœ¬çš„ release)
          # æª¢æŸ¥ develop åˆ†æ”¯æ˜¯å¦å­˜åœ¨
          if git show-ref --verify --quiet refs/remotes/origin/develop; then
            TARGETS="develop"
          else
            TARGETS=""
          fi

          for BRANCH in $HIGHER_RELEASES; do
            if [ -n "$TARGETS" ]; then
              TARGETS="$TARGETS,$BRANCH"
            else
              TARGETS="$BRANCH"
            fi
          done

          echo "Target branches: $TARGETS"

          # è½‰æ›ç‚º JSON array æ ¼å¼
          if [ -n "$TARGETS" ]; then
            JSON_ARRAY=$(echo "$TARGETS" | tr ',' '\n' | jq -R . | jq -s -c .)
            echo "branches=$JSON_ARRAY" >> $GITHUB_OUTPUT
            echo "has_targets=true" >> $GITHUB_OUTPUT
          else
            echo "branches=[]" >> $GITHUB_OUTPUT
            echo "has_targets=false" >> $GITHUB_OUTPUT
          fi

  # ç¬¬äºŒå€‹ jobï¼šåŸ·è¡Œåˆä½µ
  merge-to-branches:
    needs: calculate-targets
    if: needs.calculate-targets.outputs.has-targets == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target-branch: ${{ fromJson(needs.calculate-targets.outputs.target-branches) }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.PAT_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Merge ${{ needs.calculate-targets.outputs.source-branch }} to ${{ matrix.target-branch }}
        run: |
          SOURCE_BRANCH="${{ needs.calculate-targets.outputs.source-branch }}"
          TARGET_BRANCH="${{ matrix.target-branch }}"

          echo "Fetching all branches..."
          git fetch origin

          echo "Checking out $TARGET_BRANCH..."
          git checkout "$TARGET_BRANCH"

          echo "Merging $SOURCE_BRANCH into $TARGET_BRANCH..."
          git merge "origin/$SOURCE_BRANCH" --no-edit

          echo "Pushing changes to $TARGET_BRANCH..."
          git push origin "$TARGET_BRANCH"

      - name: Create PR on merge conflict
        id: create-pr
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const targetBranch = '${{ matrix.target-branch }}';
            const sourceBranch = '${{ needs.calculate-targets.outputs.source-branch }}';

            // Check if PR already exists
            const { data: existingPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${sourceBranch}`,
              base: targetBranch,
              state: 'open'
            });

            if (existingPRs.length > 0) {
              console.log(`PR already exists: ${existingPRs[0].html_url}`);
              core.setOutput('pr_url', existingPRs[0].html_url);
              core.setOutput('pr_existed', 'true');
              return;
            }

            // Create new PR
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸ”€ Merge ${sourceBranch} into ${targetBranch}`,
              head: sourceBranch,
              base: targetBranch,
              body: `## Auto-merge failed due to conflicts\n\nThis PR was automatically created because the auto-merge from \`${sourceBranch}\` to \`${targetBranch}\` failed.\n\nPlease resolve the conflicts manually and merge this PR.\n\n---\nğŸ¤– Created by GitHub Actions`
            });

            console.log(`Created PR: ${pr.html_url}`);
            core.setOutput('pr_url', pr.html_url);
            core.setOutput('pr_existed', 'false');

      - name: Notify Google Chat on merge conflict
        if: failure()
        run: |
          SOURCE_BRANCH="${{ needs.calculate-targets.outputs.source-branch }}"
          TARGET_BRANCH="${{ matrix.target-branch }}"
          PR_URL="${{ steps.create-pr.outputs.pr_url }}"
          PR_EXISTED="${{ steps.create-pr.outputs.pr_existed }}"
          REPO="${{ github.repository }}"
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # æ ¹æ“š PR å»ºç«‹ç‹€æ…‹è¨­å®šæ¨™é¡Œå’ŒæŒ‰éˆ•
          if [ -n "$PR_URL" ]; then
            if [ "$PR_EXISTED" = "true" ]; then
              TITLE="âš ï¸ Auto-merge ä»æœ‰è¡çªå¾…è™•ç†"
              PR_TEXT="PR å·²å­˜åœ¨"
            else
              TITLE="ğŸš¨ Auto-merge å¤±æ•— - å·²å»ºç«‹ PR"
              PR_TEXT="å·²å»ºç«‹ PR"
            fi
            # æœ‰ PR URL æ™‚é¡¯ç¤º PR æŒ‰éˆ•
            BUTTONS='[{"text": "æŸ¥çœ‹ PR", "onClick": {"openLink": {"url": "'"${PR_URL}"'"}}}, {"text": "æŸ¥çœ‹ Workflow", "onClick": {"openLink": {"url": "'"${RUN_URL}"'"}}}]'
            PR_WIDGET='{"decoratedText": {"topLabel": "'"${PR_TEXT}"'", "text": "'"${PR_URL}"'"}},'
          else
            TITLE="ğŸš¨ Auto-merge å¤±æ•— - éœ€è¦æ‰‹å‹•è™•ç†"
            PR_TEXT="ç„¡æ³•å»ºç«‹ PRï¼ˆæ¬Šé™ä¸è¶³ï¼‰"
            # æ²’æœ‰ PR URL æ™‚åªé¡¯ç¤º Workflow æŒ‰éˆ•
            BUTTONS='[{"text": "æŸ¥çœ‹ Workflow", "onClick": {"openLink": {"url": "'"${RUN_URL}"'"}}}]'
            PR_WIDGET='{"decoratedText": {"topLabel": "ç‹€æ…‹", "text": "'"${PR_TEXT}"'"}},'
          fi

          curl -X POST "${{ secrets.GOOGLE_CHAT_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d @- << EOF
          {
            "cardsV2": [{
              "cardId": "merge-conflict-card",
              "card": {
                "header": {
                  "title": "${TITLE}",
                  "subtitle": "${REPO}"
                },
                "sections": [{
                  "widgets": [
                    {
                      "decoratedText": {
                        "topLabel": "ä¾†æºåˆ†æ”¯",
                        "text": "${SOURCE_BRANCH}"
                      }
                    },
                    {
                      "decoratedText": {
                        "topLabel": "ç›®æ¨™åˆ†æ”¯",
                        "text": "${TARGET_BRANCH}"
                      }
                    },
                    ${PR_WIDGET}
                    {
                      "buttonList": {
                        "buttons": ${BUTTONS}
                      }
                    }
                  ]
                }]
              }
            }]
          }
          EOF
